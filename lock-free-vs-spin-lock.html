
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>lock-free vs spin-lock Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="lock-free-stack.html" />
    
    
    <link rel="prev" href="c11-features-in-currency.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="lock-free-programming.html">
            
                <a href="lock-free-programming.html">
            
                    
                    Lock free programming
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="c11-features-in-currency.html">
            
                <a href="c11-features-in-currency.html">
            
                    
                    C11 features in concurrency
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.4" data-path="lock-free-vs-spin-lock.html">
            
                <a href="lock-free-vs-spin-lock.html">
            
                    
                    lock-free vs spin-lock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="lock-free-stack.html">
            
                <a href="lock-free-stack.html">
            
                    
                    Lock-free Stack
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="aba-problem.html">
            
                <a href="aba-problem.html">
            
                    
                    ABA problem
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="reference.html">
            
                <a href="reference.html">
            
                    
                    Reference
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >lock-free vs spin-lock</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="lock-free-vs-spin-lock">Lock-free vs spin-lock</h1>
<p>So, given a piece of code, how do you know if it&apos;s lock-based or lock-free? Let&apos;s first see two examples. Both of them are multi-threads get access to a shared variable and do the addition on it. Here is the version by using lock-free programming.</p>
<pre><code>1  #inlcude&lt;stdio.h&gt;
2  #include&lt;stdatomic.h&gt;
3  #include&lt;pthread.h&gt;
4  _Atomic int num_circulations = 0; //record how many circulations the program has done in the while loop
5  int addr = 0;
6  void *adding(void *input)
7  {
8      int val;
9      for(int i=0; i&lt;1000000; i++)
10     {
11         do{
12             val = addr;
13             num_circulations++;
14         }while(!atomic_compare_exchange_weak(&amp;addr, &amp;val, val+1));
15     }
16     pthread_exit(NULL);
17 }
18
19 int main()
20 {
21     pthread_t tid[10];
22     for(int i=0; i&lt;10; i++)
23         pthread_create(&amp;tid[i], NULL, adding, NULL);
24     for(int i=0; i&lt;10; i++)
25         pthread_join(tid[i], NULL);
26     printf(&quot;the value of addr is %d\n&quot;, addr);
27     printf(&quot;the value of num_circulations is %d\n&quot;, num_circulation);
28 }
</code></pre><p>Here, it is the version of spin-lock for the same purpose.</p>
<pre><code>1  #include&lt;stdio.h&gt;
2  #include&lt;stdatomic.h&gt;
3  #include&lt;pthread.h&gt;
4  _Atomic int num_circulations = 0; //record how many circulations the program has done in the while loop
5  int addr = 0;
6  int lock = 0;
7  void *adding(void *input)
8  {
9      int expected = 0;
10     for(int i=0; i&lt;1000000; i++)
11     {
12         while(!atomic_compare_exchange_weak(&amp;lock, &amp;expected, 1))
13         {
14             expected = 0;
15             num_circulations++;
16         }
17         addr++;
18         lock = 0;
19     }
20 }
21
22 int main()
23 {
24     pthread_t tid[10];
25     for(int i=0; i&lt;10; i++)
26         pthread_create(&amp;tid[i], NULL, adding, NULL);
27     for(int i=0; i&lt;10; i++)
28         pthread_join(tid[i], NULL);
29     printf(&quot;the value of addr is %d\n&quot;, addr);
30     printf(&quot;the value of num_circulations is %d\n&quot;, num_circulations);
31 }
</code></pre><p>Let&apos;s see the addition part of both programs.(For the lock-free program, it is the code from line 11 to 14, for the spin-lock program, it is the code from line 12 to 18) They&apos;re both loops, and very similarly-looking ones. Moreover, we can loop at both loops for an period of time. How come they&apos;re at the opposite sides of the locking/lock-free distinction?! Where&apos;s the difference?</p>
<p>The important difference is that <em><strong>lock-free programs</strong></em><strong> are guaranteed to make progress. </strong>With a lock or spin lock,  the poor thread that can&apos;t acquire the lock <strong>can do nothing except </strong><em><strong>wait</strong> </em>(either via a busy wait or an OS-assisted sleep). If the thread that holding the lock gets suspended suddently, no thread could make progress to the program.</p>
<p>The lock-free loop, although it is also need to loop again when it fails to update the vaule of addr. However, every time it would guarantee at least one thread to make progress. Even though some threads get suspended suddently at anywhere, other threads could still make progress to do the addition.</p>
<p><img src="assets/lock-free.PNG" alt=""></p>
<p>Let&apos;s suppose there are two threads modify the value of <em>*addr</em> concurrently. Through the above image(we omit some unimportant operations), we could see that thread 1 and thread 2 both get the same local copy of <em>*addr(0)</em>, and thread 1 updates the value first and then gets suspended for a very long time. Through the definition of CAS, we could easily know that thread 2 would fail the CAS because the value of <em>*addr</em> has been change to 1, then thread 2 do the some calculation again, keep adding 1 to<em> *addr</em> no matter how long the thread 1 is suspended.</p>
<p>The second loop &#x2013; the spin lock &#x2013; will very much get stuck if another thread obtains the lock and then gets suspended before releasing it. During the suspended time of that thread who owning the lock, other threads could just do nothing but keep looping and make no progress to the addition.</p>
<p><img src="assets/lock-based.PNG" alt=""></p>
<p>As the same, let&apos;s suppose there are two threads modify the value of <em>*addr</em> concurrently. Through the above image, we could see that thread 1 gets the lock first and updates the value of <em>*addr</em>. However, before it changes the state of lock, it gets suspended! While at the same time, thread 2 could just keep looping, testing the CAS and failing again and again. So, if thread 1 gets suspended for a very very long time, the thread 2 would be blocked and the value of <em>*addr</em> would being 1 forever. This is very different from the lock-free example!</p>
<p>So the main difference between lock-free and lock-based program is in whether other threads could make progress if some threads get suspended. If yes, it is lock-free, or it is lock-based.</p>
<p>Let&apos;s see the output and performance of the above two programs.</p>
<p>Lock-free:</p>
<pre><code>the value of addr is 10000000
the value of num_circulations is 25514047

Below is the running time:

real 0m2.687s
user 0m10.652s
sys  0m0.0004s
</code></pre><p>Lock-based:</p>
<pre><code>the value of addr is 10000000
the value of num_circulations is 33141980

Below is the running time:

real 0m3.755s
user 0m14.820s
sys  0m0.012s
</code></pre><p>From the result of lock-free, we could see that every time when CAS fails, the thread should redo the whole part in the while-loop, while for the lock-based, the other threads would keep looping when one thread is holding the lock. Finally, in this example, we could see that lock-free program is quicker than lock-based(spin-lock) program.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="c11-features-in-currency.html" class="navigation navigation-prev " aria-label="Previous page: C11 features in concurrency">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="lock-free-stack.html" class="navigation navigation-next " aria-label="Next page: Lock-free Stack">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"lock-free vs spin-lock","level":"1.4","depth":1,"next":{"title":"Lock-free Stack","level":"1.5","depth":1,"path":"lock-free-stack.md","ref":"lock-free-stack.md","articles":[]},"previous":{"title":"C11 features in concurrency","level":"1.3","depth":1,"path":"c11-features-in-currency.md","ref":"c11-features-in-currency.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"lock-free-vs-spin-lock.md","mtime":"2017-11-08T14:40:58.712Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2017-11-08T14:41:05.217Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

