
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>lock-free vs spin-lock Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="lock-free-stack.html" />
    
    
    <link rel="prev" href="c11-features-in-currency.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="lock-free-programming.html">
            
                <a href="lock-free-programming.html">
            
                    
                    Lock free programming
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="c11-features-in-currency.html">
            
                <a href="c11-features-in-currency.html">
            
                    
                    C11 features in concurrency
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.4" data-path="lock-free-vs-spin-lock.html">
            
                <a href="lock-free-vs-spin-lock.html">
            
                    
                    lock-free vs spin-lock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="lock-free-stack.html">
            
                <a href="lock-free-stack.html">
            
                    
                    Lock-free Stack
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="aba-problem.html">
            
                <a href="aba-problem.html">
            
                    
                    ABA problem
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="reference.html">
            
                <a href="reference.html">
            
                    
                    Reference
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >lock-free vs spin-lock</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="lock-free-vs-spin-lock">Lock-free vs spin-lock</h1>
<p>So, given a piece of code, how do you know if it&apos;s lock-based or lock-free? Let&apos;s first see two examples. Both of them are multi-threads get access to a shared variable and do the addition on it. Here is the version by using lock-free programming.</p>
<pre><code>1  #inlcude&lt;stdio.h&gt;
2  #include&lt;stdatomic.h&gt;
3  #include&lt;pthread.h&gt;
4
5  int count = 0;                     
6  void *adding(void *input)
7  {
8      int val;
9      for(int i=0; i&lt;1000000; i++)
10     {
11         do{
12             val = count;
13         }while(!atomic_compare_exchange_weak(&amp;count, &amp;val, val+1));
14     }
15     pthread_exit(NULL);
16 }
17
18 int main()
19 {
20     pthread_t tid[10];
21     for(int i=0; i&lt;10; i++)
22         pthread_create(&amp;tid[i], NULL, adding, NULL);
23     for(int i=0; i&lt;10; i++)
24         pthread_join(tid[i], NULL);
25     printf(&quot;the value of count is %d\n&quot;, count);
26 }
</code></pre><p>Here is the version of spin-lock for the same purpose.</p>
<pre><code>1  #include&lt;stdio.h&gt;
2  #include&lt;stdatomic.h&gt;
3  #include&lt;pthread.h&gt;
4   
5  int count = 0;                     
6  int lock = 0;
7  void *adding(void *input)
8  {
9      int expected = 0;
10     for(int i=0; i&lt;1000000; i++)
11     {
12         while(!atomic_compare_exchange_weak(&amp;lock, &amp;expected, 1))//if the lock is 0(unlock), then set it to 1(lock)
13             expected = 0;//if the CAS fails, the expected will be set to 1, so we need to change it to 0 again.
14         count++;
15         lock = 0;
16     }
17 }
18
19 int main()
20 {
21     pthread_t tid[10];
22     for(int i=0; i&lt;10; i++)
23         pthread_create(&amp;tid[i], NULL, adding, NULL);
24     for(int i=0; i&lt;10; i++)
25         pthread_join(tid[i], NULL);
26     printf(&quot;the value of count is %d\n&quot;, count);
27 }
</code></pre><p>Let&apos;s see the output and performance of the above two programs.</p>
<p>Lock-free:</p>
<pre><code>the value of count is 10000000

Below is the running time:

real 0m2.687s
user 0m10.652s
sys  0m0.0004s
</code></pre><p>Lock-based:</p>
<pre><code>the value of count is 10000000

Below is the running time:

real 0m3.755s
user 0m14.820s
sys  0m0.012s
</code></pre><p>From the above result, we could see that lock-free program is better than spin-lock program. Let&apos;s see the addition part of both programs.(For the lock-free program, it is the code from line 11 to 13, for the spin-lock program, it is the code from line 12 to 15) They&apos;re both loops, and very similarly-looking ones. Moreover, we can loop at both loops for a period of time. How come they&apos;re at the opposite sides of the locking/lock-free distinction?! Does lock-free program really perform better than lock-based program?</p>
<p>Let&apos;s first see an example.</p>
<p>lock-free</p>
<p><img src="assets/lock-free-win.PNG" alt=""></p>
<p>lock-based</p>
<p><img src="assets/lock-based lose.PNG" alt=""></p>
<p>There are 4 threads modify the shared variable <em>count</em>, and they try to get access to the shared variable <em>count</em> and do the addition on it. From the above two images, we could see that in lock-free program, while thread 1 is accessing the shared variable <em>count</em>, other threads could also get access to the <em>count _and make progress for the program. However, for the lock-based program, while thread 1 is accessing the shared variable _count</em>, it holds the lock and other threads could not access the <em>count</em> but busy-waiting. So, here, we could see the difference between them. For the lock-free program, every thread could get access to the shared object no matter whether another thread is accessing the shared object or not.(Although sometimes, there could be some conflicts(just like thread 1), and the thread should redo its work. ) However, for the lock-based program, if one thread is accessing the shared object, other threads would be blocked and have no way to get access to the shared object. Also, from the above images, we could also know why the above lock-free program is quicker than lock-based program.</p>
<p>However, does lock-free program always perform better than lock-based program? Let&apos;s see an example.</p>
<p>lock-free</p>
<p><img src="assets/lock-free-win.PNG" alt=""></p>
<p>lock-based</p>
<p><img src="assets/lock-based win.PNG" alt=""></p>
<p>In the above images, we could see that the progress of lock-based program is quicker than lock-free program. So, it is not necessary that lock-free program always performs better than lock-based program.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="c11-features-in-currency.html" class="navigation navigation-prev " aria-label="Previous page: C11 features in concurrency">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="lock-free-stack.html" class="navigation navigation-next " aria-label="Next page: Lock-free Stack">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"lock-free vs spin-lock","level":"1.4","depth":1,"next":{"title":"Lock-free Stack","level":"1.5","depth":1,"path":"lock-free-stack.md","ref":"lock-free-stack.md","articles":[]},"previous":{"title":"C11 features in concurrency","level":"1.3","depth":1,"path":"c11-features-in-currency.md","ref":"c11-features-in-currency.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"lock-free-vs-spin-lock.md","mtime":"2017-11-13T03:01:12.047Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2017-11-13T03:01:20.120Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

